{% extends "base.html" %}

{% block title %}Mining Bot Settings - {{ bot.bot_name }}{% endblock %}

{% block content %}
<div class="landing-page-v2 min-vh-100">
    <div class="container px-3 py-4">
        <div class="row mb-4 fade-in-up">
            <div class="col">
                <h2 class="gradient-text display-5 fw-bold"><i class="bi bi-coin"></i> Mining Bot Settings</h2>
                <p class="hero-subtitle">{{ bot.bot_name }} - Configure your tap-to-earn game</p>
                <a href="{{ url_for('bot_detail', bot_id=bot.id) }}" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-arrow-left"></i> Back to Bot
                </a>
            </div>
        </div>

        {% if not owner_ton_wallet %}
        <div class="row mb-4">
            <div class="col">
                <div class="alert alert-danger fade-in-up" style="background: rgba(220, 53, 69, 0.15); border: 2px solid rgba(220, 53, 69, 0.5); color: #ff6b6b; animation-delay: 0.05s;">
                    <h5 class="mb-2"><i class="bi bi-exclamation-triangle-fill"></i> <strong>Action Required: Setup Payment Wallet</strong></h5>
                    <p class="mb-2">‚ö†Ô∏è Your bot cannot accept payments yet! Players will see errors when trying to purchase coins from the shop.</p>
                    <p class="mb-0"><strong>To fix:</strong> Scroll down and enter your TON wallet address in the "Payment & Deposit Settings" section below.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <form method="POST">
            <div class="row">
                <div class="col-lg-8">
                    <div class="feature-card mb-4 fade-in-up" style="animation-delay: 0.1s;">
                        <h5 class="gradient-text mb-4"><i class="bi bi-joystick"></i> Game Mechanics</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="tap_reward" class="form-label">Coins Per Tap</label>
                                <input type="number" class="form-control" id="tap_reward" name="tap_reward" 
                                       value="{{ settings.tap_reward }}" min="1" max="100"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">How many coins players earn per tap</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="max_energy" class="form-label">Maximum Energy</label>
                                <input type="number" class="form-control" id="max_energy" name="max_energy" 
                                       value="{{ settings.max_energy }}" min="100" max="10000"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Starting max energy capacity</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="energy_recharge_rate" class="form-label">Energy Recharge Rate</label>
                                <input type="number" class="form-control" id="energy_recharge_rate" name="energy_recharge_rate" 
                                       value="{{ settings.energy_recharge_rate }}" min="1" max="10"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Energy recharged per second</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="referral_bonus" class="form-label">Referral Bonus</label>
                                <input type="number" class="form-control" id="referral_bonus" name="referral_bonus" 
                                       value="{{ settings.referral_bonus }}" min="0" max="10000"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Coins earned per referral</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card mb-4 fade-in-up" style="animation-delay: 0.2s;">
                        <h5 class="gradient-text mb-4"><i class="bi bi-rocket"></i> Boost Pricing</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="boost_energy_cost" class="form-label">‚ö° Energy Limit Boost</label>
                                <input type="number" class="form-control" id="boost_energy_cost" name="boost_energy_cost" 
                                       value="{{ settings.boost_energy_cost }}" min="100"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Cost in coins</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="boost_multitap_cost" class="form-label">üíé Multi-Tap Boost</label>
                                <input type="number" class="form-control" id="boost_multitap_cost" name="boost_multitap_cost" 
                                       value="{{ settings.boost_multitap_cost }}" min="100"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Cost in coins</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="boost_recharge_cost" class="form-label">‚ö° Recharge Speed Boost</label>
                                <input type="number" class="form-control" id="boost_recharge_cost" name="boost_recharge_cost" 
                                       value="{{ settings.boost_recharge_cost }}" min="100"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Cost in coins</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card mb-4 fade-in-up" style="animation-delay: 0.3s;">
                        <h5 class="gradient-text mb-4"><i class="bi bi-wallet2"></i> Payment & Deposit Settings</h5>
                        <div class="alert alert-warning mb-3" style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); color: #ffc107;">
                            <i class="bi bi-exclamation-triangle-fill"></i> <strong>Important:</strong> Enter your TON wallet address below to receive all payments and deposits from your mining bot.
                        </div>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="owner_ton_wallet" class="form-label fw-bold">
                                    <i class="bi bi-wallet-fill text-warning"></i> Bot Owner TON Wallet Address (For Deposits & Payments)
                                </label>
                                <input type="text" class="form-control form-control-lg" id="owner_ton_wallet" name="owner_ton_wallet" 
                                       value="{{ owner_ton_wallet }}" placeholder="EQxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" maxlength="48"
                                       style="background: rgba(255,255,255,0.1); border: 2px solid rgba(255, 193, 7, 0.5); color: white; font-family: monospace;">
                                <div class="form-text text-white-50">
                                    <strong>Format:</strong> Must be 48 characters starting with <code>EQ</code> or <code>UQ</code><br>
                                    <strong>Purpose:</strong> This wallet will receive:
                                    <ul class="mb-0 mt-1">
                                        <li>üí∞ Shop payments when users purchase coins</li>
                                        <li>üí≥ Direct deposits from users</li>
                                        <li>üîÑ All TON cryptocurrency transactions</li>
                                    </ul>
                                    <strong class="d-block mt-2">Example:</strong> <code>EQxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx</code>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="min_withdrawal" class="form-label">Minimum Withdrawal</label>
                                <input type="number" class="form-control" id="min_withdrawal" name="min_withdrawal" 
                                       value="{{ settings.min_withdrawal }}" min="1000"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Minimum coins to withdraw</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="daily_reward_amount" class="form-label">Daily Reward Amount</label>
                                <input type="number" class="form-control" id="daily_reward_amount" name="daily_reward_amount" 
                                       value="{{ settings.daily_reward_amount }}" min="0"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Daily login bonus</div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="coin_price_usd" class="form-label">Coin Price (USD)</label>
                                <input type="number" step="0.0001" class="form-control" id="coin_price_usd" name="coin_price_usd" 
                                       value="{{ settings.coin_price_usd }}" min="0.0001"
                                       style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                                <div class="form-text text-white-50">Price per coin for shop</div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card mb-4 fade-in-up" style="animation-delay: 0.4s;">
                        <h5 class="gradient-text mb-4"><i class="bi bi-toggles"></i> Features</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enable_shop" name="enable_shop" 
                                           {% if settings.enable_shop %}checked{% endif %}
                                           style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label ms-2" for="enable_shop">
                                        <strong>üõí Enable Shop</strong>
                                        <div class="form-text text-white-50">Players can buy coins and boosts</div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enable_wallet" name="enable_wallet" 
                                           {% if settings.enable_wallet %}checked{% endif %}
                                           style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label ms-2" for="enable_wallet">
                                        <strong>üí≥ Enable Wallet Connection</strong>
                                        <div class="form-text text-white-50">TON & Telegram Wallet integration</div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enable_tasks" name="enable_tasks" 
                                           {% if settings.enable_tasks %}checked{% endif %}
                                           style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label ms-2" for="enable_tasks">
                                        <strong>üìã Enable Daily Tasks</strong>
                                        <div class="form-text text-white-50">Players can complete tasks for rewards</div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enable_leaderboard" name="enable_leaderboard" 
                                           {% if settings.enable_leaderboard %}checked{% endif %}
                                           style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label ms-2" for="enable_leaderboard">
                                        <strong>üèÜ Enable Leaderboard</strong>
                                        <div class="form-text text-white-50">Show top players ranking</div>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enable_daily_reward" name="enable_daily_reward" 
                                           {% if settings.enable_daily_reward %}checked{% endif %}
                                           style="width: 3em; height: 1.5em;">
                                    <label class="form-check-label ms-2" for="enable_daily_reward">
                                        <strong>üéÅ Enable Daily Rewards</strong>
                                        <div class="form-text text-white-50">Daily login bonus for players</div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="feature-card mb-4 fade-in-up" style="animation-delay: 0.5s;">
                        <h5 class="gradient-text mb-4"><i class="bi bi-shop"></i> Shop Items Configuration</h5>
                        <p class="text-white-50 mb-3">Configure items that players can purchase with TON cryptocurrency to get in-game coins.</p>
                        
                        <div class="table-responsive mb-3">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Price</th>
                                        <th>Currency</th>
                                        <th>Reward</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="shopItemsList">
                                    {% for item in shop_items %}
                                    <tr data-item-id="{{ item.id }}">
                                        <td>{{ item.item_name }}</td>
                                        <td>{{ item.price }}</td>
                                        <td>{{ item.currency }}</td>
                                        <td>{{ item.reward_amount }} {{ item.reward_type }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if item.is_active else 'secondary' }}">
                                                {{ 'Active' if item.is_active else 'Inactive' }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-warning edit-shop-item" data-id="{{ item.id }}" 
                                                    data-name="{{ item.item_name }}" data-desc="{{ item.item_description }}" 
                                                    data-price="{{ item.price }}" data-currency="{{ item.currency }}" 
                                                    data-reward-type="{{ item.reward_type }}" data-reward-amount="{{ item.reward_amount }}" 
                                                    data-active="{{ item.is_active }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-shop-item" data-id="{{ item.id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addShopItemModal">
                            <i class="bi bi-plus-circle"></i> Add Shop Item
                        </button>
                    </div>

                    <div class="feature-card mb-4 fade-in-up" style="animation-delay: 0.6s;">
                        <h5 class="gradient-text mb-4"><i class="bi bi-list-task"></i> Tasks Configuration</h5>
                        <p class="text-white-50 mb-3">Configure tasks that players can complete to earn rewards.</p>
                        
                        <div class="table-responsive mb-3">
                            <table class="table table-dark table-hover">
                                <thead>
                                    <tr>
                                        <th>Task Name</th>
                                        <th>Type</th>
                                        <th>Requirement</th>
                                        <th>Reward</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksList">
                                    {% for task in tasks_config %}
                                    <tr data-task-id="{{ task.id }}">
                                        <td>{{ task.task_name }}</td>
                                        <td><span class="badge bg-primary">{{ task.task_type }}</span></td>
                                        <td>{{ task.requirement_value }}</td>
                                        <td>{{ task.reward_amount }} {{ task.reward_type }}</td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if task.is_active else 'secondary' }}">
                                                {{ 'Active' if task.is_active else 'Inactive' }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-warning edit-task" data-id="{{ task.id }}" 
                                                    data-name="{{ task.task_name }}" data-desc="{{ task.task_description }}" 
                                                    data-type="{{ task.task_type }}" data-reward-amount="{{ task.reward_amount }}" 
                                                    data-reward-type="{{ task.reward_type }}" data-requirement="{{ task.requirement_value }}"
                                                    data-active="{{ task.is_active }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-sm btn-danger delete-task" data-id="{{ task.id }}">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                            <i class="bi bi-plus-circle"></i> Add Task
                        </button>
                    </div>

                    <div class="d-grid gap-2 fade-in-up" style="animation-delay: 0.7s;">
                        <button type="submit" class="btn btn-primary-gradient btn-lg">
                            <i class="bi bi-save"></i> Save Settings
                        </button>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="feature-card mb-4 fade-in-up sticky-top" style="animation-delay: 0.1s; top: 20px;">
                        <h5 class="gradient-text mb-4"><i class="bi bi-info-circle"></i> Quick Tips</h5>
                        <div class="alert" style="background: rgba(106, 90, 205, 0.1); border: 1px solid rgba(106, 90, 205, 0.3); color: white; margin-bottom: 15px;">
                            <strong>üí° Balanced Settings</strong>
                            <p class="mb-0 small">Start with default values and adjust based on player feedback. Higher rewards = faster coin inflation.</p>
                        </div>
                        <div class="alert" style="background: rgba(34, 139, 34, 0.1); border: 1px solid rgba(34, 139, 34, 0.3); color: white; margin-bottom: 15px;">
                            <strong>üéÆ Engagement Tips</strong>
                            <p class="mb-0 small">Enable all features for maximum player engagement. Tasks and daily rewards keep players coming back!</p>
                        </div>
                        <div class="alert" style="background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); color: white;">
                            <strong>üí∞ Monetization</strong>
                            <p class="mb-0 small">Enable shop and wallet features to let players purchase coins or withdraw earnings.</p>
                        </div>

                        <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">

                        <h6 class="text-white mb-3">Current Configuration</h6>
                        <p class="mb-2"><i class="bi bi-coin text-warning"></i> <strong>Per Tap:</strong> {{ settings.tap_reward }} coins</p>
                        <p class="mb-2"><i class="bi bi-lightning-charge text-info"></i> <strong>Max Energy:</strong> {{ settings.max_energy }}</p>
                        <p class="mb-2"><i class="bi bi-people text-success"></i> <strong>Referral:</strong> {{ settings.referral_bonus }} coins</p>
                        <p class="mb-0"><i class="bi bi-wallet text-primary"></i> <strong>Min Withdrawal:</strong> {{ settings.min_withdrawal }} coins</p>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Add Shop Item Modal -->
<div class="modal fade" id="addShopItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Add Shop Item</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addShopItemForm">
                    <div class="mb-3">
                        <label class="form-label">Item Name</label>
                        <input type="text" class="form-control" name="item_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="item_description" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control" name="price" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Currency</label>
                            <select class="form-control" name="currency">
                                <option value="TON">TON</option>
                                <option value="USDT">USDT</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Reward Amount</label>
                            <input type="number" class="form-control" name="reward_amount" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Reward Type</label>
                            <select class="form-control" name="reward_type">
                                <option value="coins">Coins</option>
                                <option value="energy">Energy</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addShopItem()">Add Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Add Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTaskForm">
                    <div class="mb-3">
                        <label class="form-label">Task Name</label>
                        <input type="text" class="form-control" name="task_name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="task_description" rows="2"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Task Type</label>
                            <select class="form-control" name="task_type">
                                <option value="daily">Daily</option>
                                <option value="mining">Mining</option>
                                <option value="referral">Referral</option>
                                <option value="streak">Streak</option>
                                <option value="social">Social</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Requirement Value</label>
                            <input type="number" class="form-control" name="requirement_value" placeholder="e.g., 1000 coins">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Reward Amount</label>
                            <input type="number" class="form-control" name="reward_amount" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Reward Type</label>
                            <select class="form-control" name="reward_type">
                                <option value="coins">Coins</option>
                                <option value="energy">Energy</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTask()">Add Task</button>
            </div>
        </div>
    </div>
</div>

<script>
function addShopItem() {
    const form = document.getElementById('addShopItemForm');
    const formData = new FormData(form);
    
    fetch('/bot/{{ bot.id }}/shop-items', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function addTask() {
    const form = document.getElementById('addTaskForm');
    const formData = new FormData(form);
    
    fetch('/bot/{{ bot.id }}/tasks', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

document.querySelectorAll('.delete-shop-item').forEach(btn => {
    btn.addEventListener('click', function() {
        if (confirm('Delete this shop item?')) {
            const itemId = this.dataset.id;
            fetch(`/bot/{{ bot.id }}/shop-items/${itemId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    });
});

document.querySelectorAll('.delete-task').forEach(btn => {
    btn.addEventListener('click', function() {
        if (confirm('Delete this task?')) {
            const taskId = this.dataset.id;
            fetch(`/bot/{{ bot.id }}/tasks/${taskId}/delete`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    });
});
</script>
{% endblock %}
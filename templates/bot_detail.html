{% extends "base.html" %}

{% block title %}{{ bot.bot_name }} - BotForge Pro{% endblock %}

{% block content %}
<div class="landing-page-v2 min-vh-100">
    <div class="container-fluid px-3 py-4">
        <div class="row mb-4 fade-in-up">
            <div class="col">
                <div class="text-center mb-5">
                        <h2 class="gradient-text display-5 fw-bold"><i class="bi bi-robot"></i> {{ bot.bot_name }}</h2>
                        <p class="hero-subtitle">Bot ID: #{{ bot.id }} | Created: {{ bot.created_at[:10] }}</p>
                        {% if bot.bot_username %}
                        <div class="mt-3">
                            <a href="https://t.me/{{ bot.bot_username }}" target="_blank" class="btn btn-primary-gradient btn-lg">
                                <i class="bi bi-telegram"></i> Open Bot: @{{ bot.bot_username }}
                            </a>
                            <div class="mt-2">
                                <small class="text-white-50">Share: <code>https://t.me/{{ bot.bot_username }}</code></small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('export_bot', bot_id=bot.id) }}" class="btn btn-outline-light me-2">
                    <i class="bi bi-download"></i> Export
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light">
                    <i class="bi bi-arrow-left"></i> Back
                </a>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8 fade-in-up" style="animation-delay: 0.1s;">
                <div class="feature-card mb-4">
                    <div id="command-status-message" class="mb-3" style="display: none;"></div>
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="gradient-text mb-0"><i class="bi bi-terminal"></i> Bot Commands</h5>
                        <button class="btn btn-primary-gradient" data-bs-toggle="modal" data-bs-target="#addCommandModal">
                            <i class="bi bi-plus"></i> Add Command
                        </button>
                    </div>
                    {% if commands %}
                    <div class="table-responsive">
                        <table class="table table-dark table-hover">
                            <thead>
                                <tr>
                                    <th>Command</th>
                                    <th>Type</th>
                                    <th>Response</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for cmd in commands %}
                                <tr>
                                    <td><code>/{{ cmd.command }}</code></td>
                                    <td><span class="badge bg-info">{{ cmd.response_type }}</span></td>
                                    <td>
                                        {% if cmd.response_type == 'url' and cmd.url_link %}
                                            <strong>{{ cmd.response_content or 'Open Link' }}</strong><br>
                                            <small class="text-white-50">üîó {{ cmd.url_link[:50] }}{% if cmd.url_link|length > 50 %}...{% endif %}</small>
                                        {% else %}
                                            {{ cmd.response_content[:100] }}{% if cmd.response_content|length > 100 %}...{% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editCommand({{ cmd.id }}, '{{ cmd.command }}', '{{ cmd.response_type }}', `{{ cmd.response_content|replace('`', '\\`')|replace('\n', '\\n') }}`, '{{ cmd.url_link or '' }}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCommand({{ cmd.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-terminal display-1 text-white-50"></i>
                        <p class="mt-3 text-white-50">No commands yet. Add your first command!</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="col-md-4">
                <div id="bot-status-message" class="mb-3" style="display: none;"></div>
                <div class="feature-card p-4 mb-4">
                    <h5 class="mb-3"><i class="bi bi-gear"></i> Bot Settings</h5>
                    {% if bot.bot_type == 'telegram' %}
                    <div class="alert alert-info">
                        <strong><i class="bi bi-info-circle"></i> Activate Your Bot:</strong>
                        <p class="mb-2">Click "Setup Webhook" to make your bot respond to messages on Telegram.</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button onclick="setupWebhook({{ bot.id }})" class="btn btn-primary">
                            <i class="bi bi-cloud-arrow-up"></i> Setup Webhook
                        </button>
                        <button onclick="setBotMenu({{ bot.id }})" class="btn btn-success">
                            <i class="bi bi-list-ul"></i> Set Menu
                        </button>
                    {% elif bot.bot_type == 'webapp' %}
                    <div class="alert alert-success">
                        <strong><i class="bi bi-globe"></i> Web App Ready:</strong>
                        <p class="mb-2">Your web app is ready to deploy on Replit!</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button onclick="deployWebApp({{ bot.id }})" class="btn btn-primary">
                            <i class="bi bi-rocket"></i> Deploy Web App
                        </button>
                    {% elif bot.bot_type == 'game' %}
                    <div class="alert alert-warning">
                        <strong><i class="bi bi-controller"></i> Game Bot:</strong>
                        <p class="mb-2">Configure your game settings and launch!</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button onclick="setupGame({{ bot.id }})" class="btn btn-primary">
                            <i class="bi bi-play-circle"></i> Launch Game
                        </button>
                    {% elif bot.bot_type == 'mining' %}
                    <div class="alert alert-primary">
                        <strong><i class="bi bi-coin"></i> Mining Bot:</strong>
                        <p class="mb-2">Set up your tap-to-earn mining game!</p>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <button onclick="setupMining({{ bot.id }})" class="btn btn-primary">
                            <i class="bi bi-gear-fill"></i> Setup Mining
                        </button>
                    {% endif %}
                        <a href="{{ url_for('bot_detail', bot_id=bot.id) }}" class="btn btn-outline-primary">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </a>
                        <a href="{{ url_for('export_bot', bot_id=bot.id) }}" class="btn btn-outline-success">
                            <i class="bi bi-download"></i> Export Config
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="showDeleteBotConfirmation()">
                            <i class="bi bi-trash"></i> Delete Bot
                        </button>
                    </div>
                    <div id="webhook-status" class="mt-3"></div>
                </div>

                <div class="feature-card mb-4 fade-in-up" style="animation-delay: 0.2s;">
                    <h5 class="gradient-text mb-4"><i class="bi bi-info-circle"></i> Bot Information</h5>
                    <p><strong class="text-white">Name:</strong> <span class="text-white-50">{{ bot.bot_name }}</span></p>
                    <p><strong class="text-white">Commands:</strong> <span class="text-white-50">{{ commands|length }} (all editable)</span></p>
                    <p><strong class="text-white">Status:</strong> <span class="badge bg-success">Active</span></p>
                    <p class="mb-0"><strong class="text-white">Created:</strong><br><span class="text-white-50">{{ bot.created_at }}</span></p>
                    
                    <hr style="border-color: rgba(255,255,255,0.1);">
                    <h6 class="text-white-50 mb-2">‚ÑπÔ∏è Note:</h6>
                    <small class="text-white-50">
                        All commands including /menu, /profile, and /donate are fully editable and deletable. Customize them to match your bot's needs!
                    </small>
                </div>

                <div class="feature-card fade-in-up" style="animation-delay: 0.3s;">
                    <h5 class="gradient-text mb-4"><i class="bi bi-lightbulb"></i> Quick Actions</h5>
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary-gradient" data-bs-toggle="modal" data-bs-target="#addCommandModal">
                            <i class="bi bi-plus"></i> Add Command
                        </button>
                        <a href="{{ url_for('export_bot', bot_id=bot.id) }}" class="btn btn-outline-light">
                            <i class="bi bi-download"></i> Export Bot
                        </a>
                        <button type="button" class="btn btn-outline-danger w-100" onclick="showDeleteBotConfirmation()">
                            <i class="bi bi-trash"></i> Delete Bot
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Elements -->
    <div class="floating-element floating-1">
        <i class="bi bi-robot"></i>
    </div>
    <div class="floating-element floating-2">
        <i class="bi bi-stars"></i>
    </div>
</div>

<div class="modal fade" id="addCommandModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content" style="background: #2d3139; color: white;">
            <div class="modal-header" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                <h5 class="modal-title gradient-text"><i class="bi bi-plus-circle"></i> Add Command</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCommandForm">
                    <div class="mb-3">
                        <label for="command" class="form-label">Command Name</label>
                        <div class="input-group">
                            <span class="input-group-text" style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white;">/</span>
                            <input type="text" class="form-control" id="command" name="command" required placeholder="start" style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="response_type" class="form-label">Response Type</label>
                        <select class="form-select" id="response_type" name="response_type" onchange="toggleUrlField()" style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                            <option value="text" style="background: #2d3139; color: white;">Text</option>
                            <option value="url" style="background: #2d3139; color: white;">External URL (Opens in Bot)</option>
                            <option value="image" style="background: #2d3139; color: white;">Image</option>
                            <option value="button" style="background: #2d3139; color: white;">Button</option>
                        </select>
                    </div>
                    <div class="mb-3" id="response_content_field">
                        <label for="response_content" class="form-label">Response Content</label>
                        <textarea class="form-control" id="response_content" name="response_content" rows="4" style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;"></textarea>
                        <small class="text-white-50">For URL type, this will be the button text</small>
                    </div>
                    <div class="mb-3" id="url_link_field" style="display: none;">
                        <label for="url_link" class="form-label">External URL</label>
                        <input type="url" class="form-control" id="url_link" name="url_link" placeholder="https://example.com" style="background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); color: white;">
                        <small class="text-white-50">The URL will open inside the Telegram bot</small>
                    </div>
                    <button type="button" class="btn btn-outline-light" id="aiGenerateBtn">
                        <i class="bi bi-magic"></i> AI Generate Response
                    </button>
                </form>
            </div>
            <div class="modal-footer" style="border-top: 1px solid rgba(255,255,255,0.1);">
                <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary-gradient" id="saveCommandBtn">
                    <i class="bi bi-check"></i> Save Command
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let editingCommandId = null;

function toggleUrlField() {
    const responseType = document.getElementById('response_type').value;
    const urlField = document.getElementById('url_link_field');
    const contentField = document.getElementById('response_content_field');
    const contentInput = document.getElementById('response_content');
    
    if (responseType === 'url') {
        urlField.style.display = 'block';
        contentInput.required = false;
        contentInput.placeholder = 'Button text (e.g., "Open Website")';
    } else {
        urlField.style.display = 'none';
        contentInput.required = true;
        contentInput.placeholder = '';
    }
}

document.getElementById('saveCommandBtn').addEventListener('click', function() {
    const form = document.getElementById('addCommandForm');
    const formData = new FormData(form);
    
    const url = editingCommandId 
        ? `/bot/{{ bot.id }}/command/${editingCommandId}/edit`
        : '{{ url_for("add_command", bot_id=bot.id) }}';

    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showInlineMessage('command-status-message', 'Command saved successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showInlineMessage('command-status-message', 'Error: ' + data.error, 'danger');
        }
    });
});

function editCommand(commandId, command, responseType, responseContent, urlLink) {
    editingCommandId = commandId;
    document.getElementById('command').value = command;
    document.getElementById('response_type').value = responseType;
    document.getElementById('response_content').value = responseContent;
    document.getElementById('url_link').value = urlLink || '';
    toggleUrlField();
    document.querySelector('#addCommandModal .modal-title').innerHTML = '<i class="bi bi-pencil-circle"></i> Edit Command';
    document.getElementById('saveCommandBtn').innerHTML = '<i class="bi bi-check"></i> Update Command';
    new bootstrap.Modal(document.getElementById('addCommandModal')).show();
}

function deleteCommand(commandId) {
    const message = `
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Are you sure?</strong> This will permanently delete this command.
            <div class="mt-2">
                <button class="btn btn-sm btn-danger me-2" onclick="confirmDeleteCommand(${commandId})">Yes, Delete</button>
                <button class="btn btn-sm btn-secondary" onclick="hideInlineMessage('command-status-message')">Cancel</button>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    showInlineMessage('command-status-message', message, '', true);
}

function confirmDeleteCommand(commandId) {
    fetch(`/bot/{{ bot.id }}/command/${commandId}/delete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showInlineMessage('command-status-message', 'Command deleted successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showInlineMessage('command-status-message', 'Error: ' + data.error, 'danger');
        }
    });
}

document.getElementById('addCommandModal').addEventListener('hidden.bs.modal', function() {
    editingCommandId = null;
    document.getElementById('addCommandForm').reset();
    document.querySelector('#addCommandModal .modal-title').innerHTML = '<i class="bi bi-plus-circle"></i> Add Command';
    document.getElementById('saveCommandBtn').innerHTML = '<i class="bi bi-check"></i> Save Command';
    toggleUrlField();
});

document.getElementById('aiGenerateBtn').addEventListener('click', function() {
    const command = document.getElementById('command').value;
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';

    fetch('/api/ai/generate-response', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({command: command, description: ''})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('response_content').value = data.response;
            showInlineMessage('command-status-message', 'AI response generated successfully!', 'success');
        } else {
            showInlineMessage('command-status-message', data.error || 'AI generation failed', 'danger');
        }
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-magic"></i> AI Generate Response';
    });
});

function setupWebhook(botId) {
    const webhookStatusDiv = document.getElementById('webhook-status');
    webhookStatusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Setting up webhook...';

    fetch(`/bot/${botId}/setup-webhook`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            webhookStatusDiv.innerHTML = '<div class="alert alert-success mb-0">Webhook setup successful! Your bot is now live.</div>';
        } else {
            webhookStatusDiv.innerHTML = `<div class="alert alert-danger mb-0">Error setting up webhook: ${data.error}</div>`;
        }
    })
    .catch(error => {
        webhookStatusDiv.innerHTML = '<div class="alert alert-danger mb-0">An unexpected error occurred. Please try again.</div>';
        console.error('Webhook setup error:', error);
    });
}

function deployWebApp(botId) {
    const webhookStatusDiv = document.getElementById('webhook-status');
    webhookStatusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Deploying web app...';

    fetch(`/bot/${botId}/deploy-webapp`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            webhookStatusDiv.innerHTML = `
                <div class="alert alert-success mb-0">
                    <strong>‚úÖ Web App Deployed!</strong><br>
                    üîó URL: <a href="${data.webapp_url}" target="_blank" class="text-white">${data.webapp_url}</a><br>
                    <small>Share this link to let users access your app!</small>
                </div>`;
        } else {
            webhookStatusDiv.innerHTML = `<div class="alert alert-danger mb-0">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        webhookStatusDiv.innerHTML = '<div class="alert alert-danger mb-0">An unexpected error occurred. Please try again.</div>';
        console.error('Deploy error:', error);
    });
}

function setupGame(botId) {
    const webhookStatusDiv = document.getElementById('webhook-status');
    webhookStatusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Setting up game...';

    fetch(`/bot/${botId}/setup-game`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            webhookStatusDiv.innerHTML = `
                <div class="alert alert-success mb-0">
                    <strong>üéÆ Game Bot Active!</strong><br>
                    Players can now start playing your game!<br>
                    <small>Use /play command in Telegram to start</small>
                </div>`;
        } else {
            webhookStatusDiv.innerHTML = `<div class="alert alert-danger mb-0">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        webhookStatusDiv.innerHTML = '<div class="alert alert-danger mb-0">An unexpected error occurred. Please try again.</div>';
        console.error('Game setup error:', error);
    });
}

function setupMining(botId) {
    const webhookStatusDiv = document.getElementById('webhook-status');
    webhookStatusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Setting up mining bot...';

    fetch(`/bot/${botId}/setup-mining`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let botLinkHtml = '';
            if (data.bot_link) {
                botLinkHtml = `
                    <hr>
                    <strong>üîó Bot Link:</strong><br>
                    <a href="${data.bot_link}" target="_blank" class="text-white fw-bold">${data.bot_link}</a><br>
                    <button class="btn btn-sm btn-outline-light mt-2" onclick="copyToClipboard('${data.bot_link}')">
                        <i class="bi bi-clipboard"></i> Copy Link
                    </button>
                `;
            }

            webhookStatusDiv.innerHTML = `
                <div class="alert alert-success mb-0">
                    <strong>‚õèÔ∏è Mining Bot Ready!</strong><br>
                    üíé Tap reward: 1 coin per tap<br>
                    ‚ö° Energy: 1000/1000<br>
                    üéÅ Referral bonus: 500 coins<br>
                    ${botLinkHtml}
                    <small class="d-block mt-2">Share your bot link to start mining!</small>
                </div>`;
        } else {
            webhookStatusDiv.innerHTML = `<div class="alert alert-danger mb-0">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        webhookStatusDiv.innerHTML = '<div class="alert alert-danger mb-0">An unexpected error occurred. Please try again.</div>';
        console.error('Mining setup error:', error);
    });
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showInlineMessage('bot-status-message', 'Bot link copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Failed to copy:', err);
        showInlineMessage('bot-status-message', 'Failed to copy to clipboard', 'danger');
    });
}

function setBotMenu(botId) {
    const webhookStatusDiv = document.getElementById('webhook-status');
    webhookStatusDiv.innerHTML = '<div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Loading...</span></div> Setting up menu...';

    fetch(`/bot/${botId}/set-menu`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            webhookStatusDiv.innerHTML = `
                <div class="alert alert-success mb-0">
                    <strong>‚úÖ Bot Menu Set!</strong><br>
                    Your bot now has an interactive command menu!<br>
                    <small>Users can tap the menu button (‚ò∞) to see all commands.</small><br><br>
                    <strong>Built-in commands added:</strong><br>
                    ‚Ä¢ /menu - Interactive command buttons<br>
                    ‚Ä¢ /profile - View user details<br>
                    ‚Ä¢ /donate - Support developer
                </div>`;
        } else {
            webhookStatusDiv.innerHTML = `<div class="alert alert-danger mb-0">Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        webhookStatusDiv.innerHTML = '<div class="alert alert-danger mb-0">An unexpected error occurred. Please try again.</div>';
        console.error('Menu setup error:', error);
    });
}

function showInlineMessage(elementId, message, type = 'info', isRaw = false) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    if (isRaw) {
        element.innerHTML = message;
    } else {
        element.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        `;
    }
    element.style.display = 'block';
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success' && !isRaw) {
        setTimeout(() => {
            element.style.display = 'none';
        }, 5000);
    }
}

function hideInlineMessage(elementId) {
    const element = document.getElementById(elementId);
    if (element) {
        element.style.display = 'none';
        element.innerHTML = '';
    }
}

function showDeleteBotConfirmation() {
    const message = `
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <h5 class="alert-heading">‚ö†Ô∏è Delete Bot</h5>
            <p>Are you sure you want to delete <strong>{{ bot.bot_name }}</strong>?</p>
            <p class="mb-0 small">This action cannot be undone. All commands and settings will be permanently deleted.</p>
            <hr>
            <div class="d-flex gap-2">
                <form method="POST" action="{{ url_for('delete_bot', bot_id=bot.id) }}" class="flex-grow-1">
                    <button type="submit" class="btn btn-danger w-100">
                        <i class="bi bi-trash"></i> Yes, Delete Bot
                    </button>
                </form>
                <button class="btn btn-secondary" onclick="hideInlineMessage('bot-status-message')">
                    Cancel
                </button>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    showInlineMessage('bot-status-message', message, '', true);
    
    // Scroll to message
    document.getElementById('bot-status-message').scrollIntoView({ behavior: 'smooth', block: 'center' });
}
</script>
{% endblock %}